name: Release

on:
  push:
    tags: ['*']
  workflow_dispatch:
    inputs:
      tag_name:
        description: "Tag name for the release"
        required: true
        default: "v1.0.0"

jobs:
  build-macos:
    name: Build macOS Universal Binary
    runs-on: macos-15
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode_16.4.app/Contents/Developer
        
      - name: Show Swift version
        run: swift --version
        
      - name: Cache Swift Package Manager
        uses: actions/cache@v4
        with:
          path: |
            .build
            ~/.cache/org.swift.swiftpm
          key: ${{ runner.os }}-spm-release-${{ hashFiles('Package.swift', 'Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-release-
            ${{ runner.os }}-spm-
            
      - name: Resolve dependencies
        run: swift package resolve
          
      - name: Build universal binary with validation
        run: |
          echo "Building universal macOS binary..."
          swift build -c release --arch arm64 --arch x86_64 -Xswiftc -Osize
          
          # Verify the binary was created
          if [ ! -f ".build/apple/Products/Release/swift-dependency-audit" ]; then
            echo "❌ Binary not found after build"
            exit 1
          fi
          
          echo "✅ Binary built successfully"
          
      - name: Strip and optimize binary
        run: |
          echo "Stripping debug symbols for size optimization..."
          strip -rSTx .build/apple/Products/Release/swift-dependency-audit
          
          # Display binary information
          echo "Binary information:"
          ls -la .build/apple/Products/Release/swift-dependency-audit
          file .build/apple/Products/Release/swift-dependency-audit
          du -h .build/apple/Products/Release/swift-dependency-audit
          
      - name: Comprehensive binary validation
        run: |
          echo "=== Validating macOS binary functionality ==="
          
          # Test basic commands
          .build/apple/Products/Release/swift-dependency-audit --version
          .build/apple/Products/Release/swift-dependency-audit --help
          
          echo "=== Testing self-analysis ==="
          .build/apple/Products/Release/swift-dependency-audit . --verbose --exclude-tests
          
          echo "=== Testing JSON output ==="
          .build/apple/Products/Release/swift-dependency-audit . --json --no-color > test-output.json
          cat test-output.json | python3 -m json.tool > /dev/null || (echo "❌ Invalid JSON output" && exit 1)
          echo "✅ JSON output validation passed"
          
          echo "=== Testing different output formats ==="
          .build/apple/Products/Release/swift-dependency-audit . --output-format xcode --quiet
          .build/apple/Products/Release/swift-dependency-audit . --output-format github-actions --quiet
          
          echo "✅ All macOS binary validations passed"
          
      - name: Upload macOS binary
        uses: actions/upload-artifact@v4
        with:
          name: swift-dependency-audit-macos
          path: .build/apple/Products/Release/swift-dependency-audit
          retention-days: 30
          
  build-linux:
    name: Build Linux Binaries
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x86_64
            runner: ubuntu-latest
            triple: x86_64-unknown-linux-gnu
          - arch: aarch64
            runner: ubuntu-24.04-arm
            triple: aarch64-unknown-linux-gnu
    runs-on: ${{ matrix.runner }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Swift
        run: |
          # Check if Swift is already available
          if command -v swift >/dev/null 2>&1; then
            echo "Swift is already available:"
            swift --version
          else
            echo "Installing Swift using Swiftly..."
            
            # Install Swiftly
            curl -L https://swift-server.github.io/swiftly/swiftly-install.sh | bash
            
            # Add Swiftly to PATH for current session
            export PATH="$HOME/.local/bin:$PATH"
            echo "$HOME/.local/bin" >> $GITHUB_PATH
            
            # Install latest Swift toolchain
            swiftly install latest
            swiftly use latest
            
            echo "Swift installation completed:"
            swift --version
          fi

      - name: Cache Swift Package Manager
        uses: actions/cache@v4
        with:
          path: |
            .build
            ~/.cache/org.swift.swiftpm
          key: ${{ runner.os }}-${{ matrix.arch }}-spm-release-${{ hashFiles('Package.swift', 'Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.arch }}-spm-
            ${{ runner.os }}-spm-

      - name: Build optimized static binary
        run: |
          echo "Building static Linux binary for ${{ matrix.arch }}..."
          swift package resolve
          swift build -c release --triple ${{ matrix.triple }} -Xswiftc -Osize --static-swift-stdlib
          strip .build/${{ matrix.triple }}/release/swift-dependency-audit
          
          # Verify binary
          ls -la .build/${{ matrix.triple }}/release/swift-dependency-audit
          file .build/${{ matrix.triple }}/release/swift-dependency-audit
          .build/${{ matrix.triple }}/release/swift-dependency-audit --version

      - name: Upload Linux binary artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-${{ matrix.arch }}-binary
          path: .build/${{ matrix.triple }}/release/swift-dependency-audit
          retention-days: 30
          
  create-release:
    runs-on: ubuntu-latest
    needs: [build-macos, build-linux]
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        
      - name: Setup artifact structure
        run: |
          # Create the build directory structure expected by our script
          mkdir -p .build/apple/Products/Release
          mkdir -p .build/x86_64-unknown-linux-gnu/release
          mkdir -p .build/aarch64-unknown-linux-gnu/release
          
          # Copy binaries to expected locations
          cp swift-dependency-audit-macos/swift-dependency-audit .build/apple/Products/Release/
          cp linux-x86_64-binary/swift-dependency-audit .build/x86_64-unknown-linux-gnu/release/
          cp linux-aarch64-binary/swift-dependency-audit .build/aarch64-unknown-linux-gnu/release/
          
          # Make binaries executable
          chmod +x .build/apple/Products/Release/swift-dependency-audit
          chmod +x .build/x86_64-unknown-linux-gnu/release/swift-dependency-audit
          chmod +x .build/aarch64-unknown-linux-gnu/release/swift-dependency-audit
          
      - name: Install 7zip
        run: sudo apt-get update && sudo apt-get install -y p7zip-full
        
      - name: Create artifact bundle using Makefile
        run: |
          # Get version from git tag or manual input
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.tag_name }}"
          else
            VERSION=${GITHUB_REF#refs/tags/}
          fi
          VERSION=${VERSION#v}  # Remove 'v' prefix if present
          echo "Creating artifact bundle for version $VERSION using Makefile"
          
          # Update VERSION file for Makefile
          echo "$VERSION" > VERSION
          
          # Use Makefile to create artifact bundle (calls the scripts internally)
          make spm_artifactbundle
          
          # Activate production Package.swift for releases
          cp Package-production.swift Package.swift
          
          # Update Package.swift with actual checksum and version
          make update_package
          
      - name: Create traditional release archives
        run: |
          # Get version
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.tag_name }}"
          else
            VERSION=${GITHUB_REF#refs/tags/}
          fi
          VERSION=${VERSION#v}  # Remove 'v' prefix if present
          
          # Create directories for archives
          mkdir -p release
          
          # Universal macOS binary
          mkdir -p "swift-dependency-audit-$VERSION-macos-universal"
          cp .build/apple/Products/Release/swift-dependency-audit "swift-dependency-audit-$VERSION-macos-universal/"
          cp LICENSE "swift-dependency-audit-$VERSION-macos-universal/" || echo "No LICENSE file found"
          cp README.md "swift-dependency-audit-$VERSION-macos-universal/" || echo "No README.md file found"
          tar -czf "release/swift-dependency-audit-$VERSION-macos-universal.tar.gz" "swift-dependency-audit-$VERSION-macos-universal"
          
          # Linux x86_64 binary
          mkdir -p "swift-dependency-audit-$VERSION-linux-x86_64"
          cp .build/x86_64-unknown-linux-gnu/release/swift-dependency-audit "swift-dependency-audit-$VERSION-linux-x86_64/"
          cp LICENSE "swift-dependency-audit-$VERSION-linux-x86_64/" || echo "No LICENSE file found"
          cp README.md "swift-dependency-audit-$VERSION-linux-x86_64/" || echo "No README.md file found"
          tar -czf "release/swift-dependency-audit-$VERSION-linux-x86_64.tar.gz" "swift-dependency-audit-$VERSION-linux-x86_64"
          
          # Linux ARM64 binary
          mkdir -p "swift-dependency-audit-$VERSION-linux-aarch64"
          cp .build/aarch64-unknown-linux-gnu/release/swift-dependency-audit "swift-dependency-audit-$VERSION-linux-aarch64/"
          cp LICENSE "swift-dependency-audit-$VERSION-linux-aarch64/" || echo "No LICENSE file found"
          cp README.md "swift-dependency-audit-$VERSION-linux-aarch64/" || echo "No README.md file found"
          tar -czf "release/swift-dependency-audit-$VERSION-linux-aarch64.tar.gz" "swift-dependency-audit-$VERSION-linux-aarch64"
          
      - name: Generate checksums
        run: |
          cd release
          shasum -a 256 *.tar.gz > checksums.txt
          cat checksums.txt
          
      - name: Generate release notes
        run: |
          # Get version from git tag or manual input
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.tag_name }}"
          else
            VERSION=${GITHUB_REF#refs/tags/}
          fi
          
          # Make script executable and generate release notes
          chmod +x Scripts/generate-release-notes.sh
          
          # Try to extract specific version, fallback to unreleased
          if ./Scripts/generate-release-notes.sh "$VERSION" > release_notes.md 2>/dev/null; then
            echo "✅ Generated release notes from CHANGELOG.md for $VERSION"
          elif ./Scripts/generate-release-notes.sh "unreleased" > release_notes.md 2>/dev/null; then
            echo "⚠️  Specific version not found, using unreleased section"
          else
            echo "⚠️  Could not extract from CHANGELOG.md, using fallback"
            cat > release_notes.md << 'EOF'
          ## Release Notes
          
          This release includes improvements and bug fixes. See the full changelog for details.
          EOF
          fi
          
          # Add installation instructions to release notes
          cat >> release_notes.md << 'EOF'
          
          ## Binary Target Usage (Swift Package Manager Plugin)
          
          Add this to your Package.swift for build tool plugin usage:
          
          ```swift
          .binaryTarget(
              name: "SwiftDependencyAuditBinary",
              url: "https://github.com/tonyarnold/swift-dependency-audit/releases/download/${{ github.ref_name }}/swift-dependency-audit.artifactbundle.zip",
              checksum: "$(cat swift-dependency-audit.artifactbundle.zip.checksum)"
          )
          ```
          
          ## Manual Installation
          
          Download the appropriate binary for your system:
          
          - **Universal macOS** (recommended): `swift-dependency-audit-${{ github.ref_name }}-macos-universal.tar.gz`
          - **Linux x86_64**: `swift-dependency-audit-${{ github.ref_name }}-linux-x86_64.tar.gz`
          - **Linux ARM64**: `swift-dependency-audit-${{ github.ref_name }}-linux-aarch64.tar.gz`
          
          ### Quick Install (macOS)
          ```bash
          curl -L https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/swift-dependency-audit-${{ github.ref_name }}-macos-universal.tar.gz | tar -xz
          sudo mv swift-dependency-audit-${{ github.ref_name }}-macos-universal/swift-dependency-audit /usr/local/bin/
          ```
          
          ### Quick Install (Linux)
          ```bash
          curl -L https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/swift-dependency-audit-${{ github.ref_name }}-linux-x86_64.tar.gz | tar -xz
          sudo mv swift-dependency-audit-${{ github.ref_name }}-linux-x86_64/swift-dependency-audit /usr/local/bin/
          ```
          
          ## Supported Platforms
          
          - macOS (Universal: ARM64 + x86_64)
          - Linux x86_64 (static binary, no Swift runtime required)
          - Linux ARM64 (static binary, no Swift runtime required)
          
          ## Plugin Usage
          
          The binary target can be used with the SwiftDependencyAudit build tool plugin for automatic dependency validation during builds.
          
          ## Checksums
          All binaries are signed with SHA256 checksums available in `checksums.txt`.
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        if: github.event_name == 'push'
        with:
          files: |
            swift-dependency-audit.artifactbundle.zip
            swift-dependency-audit.artifactbundle.zip.checksum
            Package.swift
            release/*.tar.gz
            release/checksums.txt
          body_path: release_notes.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Upload artifacts for manual dispatch
        uses: actions/upload-artifact@v4
        if: github.event_name == 'workflow_dispatch'
        with:
          name: release-binaries
          path: |
            swift-dependency-audit.artifactbundle.zip
            swift-dependency-audit.artifactbundle.zip.checksum
            release/*.tar.gz
            release/checksums.txt
          retention-days: 30
